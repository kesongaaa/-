<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç§˜å¡”ç½— - æ‰‹åŠ¿äº’åŠ¨</title>
    <!-- å¼•å…¥ MediaPipe åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        /* --- 1. åŸºç¡€æ ·å¼ä¸æ°›å›´ --- */
        :root {
            --bg-color: #050505;
            --accent-gold: #d4af37;
            --card-width: 140px;
            --card-height: 240px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            color: #fff;
            font-family: 'Times New Roman', serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        /* --- 2. UI å±‚çº§ --- */
        #loading-screen, #intro-screen, #game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease;
            z-index: 10;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1 !important;
        }

        h1 {
            font-size: 3rem;
            color: var(--accent-gold);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            margin-bottom: 20px;
            text-align: center;
        }

        p {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 40px;
        }

        button {
            background: transparent;
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 15px 40px;
            font-size: 1.5rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        button:hover {
            background: var(--accent-gold);
            color: #000;
            box-shadow: 0 0 20px var(--accent-gold);
        }

        /* --- 3. æ‘„åƒå¤´ä¸è°ƒè¯• (éšè—æˆ–è§’è½æ˜¾ç¤º) --- */
        #webcam {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 160px;
            height: 120px;
            transform: scaleX(-1); /* é•œåƒ */
            opacity: 0.3; /* åŠé€æ˜ï¼Œä¸å¹²æ‰°è§†è§‰ */
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            z-index: 5;
        }

        /* --- 4. é­”æ³•å…‰æ ‡ (è·Ÿéšæ‰‹åŠ¿) --- */
        #magic-cursor {
            position: fixed;
            width: 30px;
            height: 30px;
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px var(--accent-gold), inset 0 0 10px var(--accent-gold);
            z-index: 100;
            transition: width 0.2s, height 0.2s; /* æåˆåŠ¨ç”» */
            display: none; /* åˆå§‹éšè— */
        }
        
        #magic-cursor.pinching {
            background-color: var(--accent-gold);
            width: 15px;
            height: 15px;
        }

        /* --- 5. è¿›åº¦åœˆ (æ‚¬åœåé¦ˆ) --- */
        .progress-ring {
            position: absolute;
            width: 60px;
            height: 60px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
        }
        
        /* --- 6. å¡ç‰ŒåŒºåŸŸ --- */
        #card-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            perspective: 1000px;
            width: 90%;
            max-width: 1200px;
            flex-wrap: wrap;
        }

        .card-wrapper {
            width: var(--card-width);
            height: var(--card-height);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .card-wrapper.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border: 2px solid #333;
        }

        /* å¡èƒŒ */
        .card-back {
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            border-color: var(--accent-gold);
        }
        .card-back::after {
            content: 'âœ¦';
            font-size: 3rem;
            color: var(--accent-gold);
        }

        /* å¡é¢ */
        .card-front {
            background: #eee;
            color: #111;
            transform: rotateY(180deg);
            flex-direction: column;
            border-color: #fff;
        }
        .card-front img {
            width: 80%;
            height: 60%;
            object-fit: cover;
            margin-bottom: 10px;
        }
        .card-front h3 {
            margin: 0;
            font-size: 1rem;
            text-align: center;
            font-family: serif;
        }

        /* --- 7. ç²’å­ç‰¹æ•ˆç”»å¸ƒ --- */
        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            :root {
                --card-width: 90px;
                --card-height: 150px;
            }
            #card-container {
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <!-- å…‰æ ‡ -->
    <div id="magic-cursor"></div>

    <!-- ç²’å­ç‰¹æ•ˆ -->
    <canvas id="particle-canvas"></canvas>

    <!-- æ‘„åƒå¤´ (ç”¨äºè°ƒè¯•åŠMediaPipeè¾“å…¥) -->
    <video id="webcam" autoplay playsinline></video>

    <!-- 1. åŠ è½½ç•Œé¢ -->
    <div id="loading-screen">
        <h1>ğŸ”®</h1>
        <p>æ­£åœ¨åŠ è½½ç¥ç§˜å¡”ç½—ç‰Œé˜µ...</p>
    </div>

    <!-- 2. å¼•å¯¼ç•Œé¢ -->
    <div id="intro-screen" class="hidden">
        <h1>å‘½è¿ä¹‹è½®</h1>
        <p>è¯·å…è®¸ä½¿ç”¨æ‘„åƒå¤´ï¼Œå¹¶ä¸¾èµ·æ‚¨çš„æ‰‹ã€‚</p>
        <p>ç”¨é£ŸæŒ‡æ§åˆ¶å…‰æ ‡ï¼Œæ‚¬åœæˆ–æåˆæ¥ç¿»å¼€å¡ç‰Œã€‚</p>
        <button id="start-btn">å¼€å§‹æŠ½å¡</button>
    </div>

    <!-- 3. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-screen" class="hidden">
        <h2 style="position: absolute; top: 10%; width: 100%; text-align: center; color: var(--accent-gold);">è¯·ç”¨æ‰‹åŠ¿é€‰æ‹©æ‚¨çš„å¡ç‰Œ</h2>
        <div id="card-container">
            <!-- å¡ç‰Œå°†ç”±JSç”Ÿæˆ -->
        </div>
    </div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

        /* --- é…ç½®ä¸çŠ¶æ€ --- */
        const tarotData = [
            { name: "æ„šè€…", imgUrl: "https://images.unsplash.com/photo-1634914757361-b84497cc3029?q=80&w=200&auto=format&fit=crop", desc: "æ–°çš„å¼€å§‹ï¼Œè‡ªç”±" },
            { name: "åŠ›é‡", imgUrl: "https://images.unsplash.com/photo-1596707323569-b57d6d396956?q=80&w=200&auto=format&fit=crop", desc: "å‹‡æ°”ï¼Œè€å¿ƒ" },
            { name: "æ­»ç¥", imgUrl: "https://images.unsplash.com/photo-1515286105367-7b243b46985e?q=80&w=200&auto=format&fit=crop", desc: "ç»“æŸï¼Œé‡ç”Ÿ" },
            { name: "æœˆäº®", imgUrl: "https://images.unsplash.com/photo-1532960401447-7dd05bef20b0?q=80&w=200&auto=format&fit=crop", desc: "æ½œæ„è¯†ï¼Œå¹»è§‰" },
            { name: "æˆ˜è½¦", imgUrl: "https://images.unsplash.com/photo-1601026040854-44a69145942f?q=80&w=200&auto=format&fit=crop", desc: "æ„å¿—åŠ›ï¼Œèƒœåˆ©" }
        ];

        let handLandmarker = undefined;
        let webcamRunning = false;
        let lastVideoTime = -1;
        
        // DOM å…ƒç´ 
        const video = document.getElementById("webcam");
        const cursor = document.getElementById("magic-cursor");
        const cardContainer = document.getElementById("card-container");
        const particleCanvas = document.getElementById("particle-canvas");
        const ctx = particleCanvas.getContext('2d');

        // äº¤äº’çŠ¶æ€
        let hoverStartTime = 0;
        let hoveredCardIndex = -1;
        const HOVER_THRESHOLD = 1000; // æ‚¬åœ1ç§’è§¦å‘
        const PINCH_THRESHOLD = 0.05; // æåˆè·ç¦»é˜ˆå€¼

        // åˆå§‹åŒ–
        async function createHandLandmarker() {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
            
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('intro-screen').classList.remove('hidden');
        }

        createHandLandmarker();

        /* --- æ¸¸æˆé€»è¾‘ --- */
        
        // 1. ç”Ÿæˆå¡ç‰Œ
        function initCards() {
            cardContainer.innerHTML = '';
            tarotData.forEach((card, index) => {
                const el = document.createElement('div');
                el.className = 'card-wrapper';
                el.dataset.index = index;
                el.innerHTML = `
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front">
                        <img src="${card.imgUrl}" alt="${card.name}">
                        <h3>${card.name}</h3>
                    </div>
                `;
                cardContainer.appendChild(el);
            });
        }

        // 2. å¼€å§‹æ¸¸æˆ
        document.getElementById('start-btn').addEventListener('click', async () => {
            // è¯·æ±‚æ‘„åƒå¤´
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                webcamRunning = true;
                
                initCards();
                resizeCanvas();
                
                document.getElementById('intro-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                cursor.style.display = "block";
                
            } catch (err) {
                alert("éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½è¿›è¡Œæ‰‹åŠ¿äº’åŠ¨ï¼");
                console.error(err);
            }
        });

        // 3. æ ¸å¿ƒå¾ªç¯ï¼šæ‰‹åŠ¿è¯†åˆ«ä¸äº¤äº’
        async function predictWebcam() {
            if (!handLandmarker) return;

            // ä¿æŒCanvaså°ºå¯¸
            if (video.videoWidth !== particleCanvas.width) {
                resizeCanvas();
            }

            let startTimeMs = performance.now();
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, startTimeMs);

                if (results.landmarks && results.landmarks.length > 0) {
                    const landmarks = results.landmarks[0];
                    
                    // è·å–é£ŸæŒ‡æŒ‡å°–(8)å’Œæ‹‡æŒ‡æŒ‡å°–(4)åæ ‡
                    const indexTip = landmarks[8];
                    const thumbTip = landmarks[4];
                    
                    // æ˜ å°„åˆ°å±å¹•åæ ‡ (æ³¨æ„ webcam éœ€è¦é•œåƒ)
                    // x: 1 - x å› ä¸ºéœ€è¦é•œåƒç¿»è½¬
                    const screenX = (1 - indexTip.x) * window.innerWidth;
                    const screenY = indexTip.y * window.innerHeight;

                    // æ›´æ–°å…‰æ ‡ä½ç½®
                    cursor.style.left = `${screenX}px`;
                    cursor.style.top = `${screenY}px`;

                    // è®¡ç®—æåˆè·ç¦» (ç®€å•çš„æ¬§å‡ é‡Œå¾—è·ç¦»)
                    const pinchDist = Math.sqrt(
                        Math.pow(indexTip.x - thumbTip.x, 2) + 
                        Math.pow(indexTip.y - thumbTip.y, 2)
                    );

                    const isPinching = pinchDist < PINCH_THRESHOLD;
                    if(isPinching) {
                        cursor.classList.add('pinching');
                    } else {
                        cursor.classList.remove('pinching');
                    }

                    // ç¢°æ’æ£€æµ‹ä¸è§¦å‘
                    checkInteraction(screenX, screenY, isPinching);
                } else {
                    // æ²¡æœ‰æ£€æµ‹åˆ°æ‰‹
                    cursor.style.display = 'none';
                }
            }

            // æ›´æ–°ç²’å­åŠ¨ç”»
            updateParticles();

            if (webcamRunning) {
                window.requestAnimationFrame(predictWebcam);
            }
        }

        function checkInteraction(x, y, isPinching) {
            cursor.style.display = 'block';
            
            // è·å–æ‰€æœ‰å¡ç‰Œå…ƒç´ 
            const cards = document.querySelectorAll('.card-wrapper');
            let foundHover = false;

            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                const isOver = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
                
                if (isOver && !card.classList.contains('flipped')) {
                    foundHover = true;
                    const index = parseInt(card.dataset.index);

                    // å¢åŠ è¾¹æ¡†é«˜äº®æš—ç¤º
                    card.style.boxShadow = "0 0 25px var(--accent-gold)";

                    // é€»è¾‘ A: æåˆç«‹å³è§¦å‘
                    if (isPinching) {
                        flipCard(card);
                        return;
                    }

                    // é€»è¾‘ B: æ‚¬åœè®¡æ—¶è§¦å‘
                    if (hoveredCardIndex !== index) {
                        hoveredCardIndex = index;
                        hoverStartTime = performance.now();
                    } else {
                        if (performance.now() - hoverStartTime > HOVER_THRESHOLD) {
                            flipCard(card);
                        }
                    }
                } else {
                    card.style.boxShadow = ""; // ç§»é™¤é«˜äº®
                }
            });

            if (!foundHover) {
                hoveredCardIndex = -1;
                hoverStartTime = 0;
            }
        }

        function flipCard(cardElement) {
            if (cardElement.classList.contains('flipped')) return;
            
            cardElement.classList.add('flipped');
            
            // è§¦å‘ç²’å­
            const rect = cardElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            spawnParticles(centerX, centerY);

            // é‡ç½®çŠ¶æ€é˜²æ­¢è¿ç»­è§¦å‘
            hoveredCardIndex = -1; 
        }

        /* --- ç²’å­ç‰¹æ•ˆç³»ç»Ÿ --- */
        let particles = [];

        function resizeCanvas() {
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function spawnParticles(x, y) {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0,
                    color: `hsl(${45 + Math.random() * 20}, 100%, 70%)` // é‡‘è‰²ç³»
                });
            }
        }

        function updateParticles() {
            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.1; // é‡åŠ›
                p.life -= 0.02;

                if (p.life <= 0) {
                    particles.splice(i, 1);
                } else {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            ctx.globalAlpha = 1.0;
        }

    </script>
</body>
</html>