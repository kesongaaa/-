<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç§˜å¡”ç½— - æ‰‹åŠ¿é©±åŠ¨</title>
    <!-- å¼•å…¥ MediaPipe Hands å’Œ Camera Utils -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- åŸºç¡€æ ·å¼ä¸æš—é»‘æ°›å›´ --- */
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
            font-family: 'Cinzel', serif; /* ç±»ä¼¼è¡¬çº¿å­—ä½“ */
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            perspective: 1000px;
        }

        /* æ‘„åƒå¤´é¢„è§ˆï¼ˆç”¨äºè°ƒè¯•ï¼Œå®é™…å¯éšè—æˆ–ç¼©å°ï¼‰ */
        .input_video {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 160px;
            height: 120px;
            border: 2px solid #444;
            opacity: 0.3;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            z-index: 100;
        }

        /* æç¤ºæ–‡å­— */
        #status-text {
            position: absolute;
            top: 10%;
            font-size: 24px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #b19cd9;
            opacity: 0.8;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        /* --- å¡ç‰Œå®¹å™¨ --- */
        #card-container {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            transform-style: preserve-3d;
            height: 300px;
            width: 80%;
        }

        /* --- å¡ç‰Œæ ·å¼ (3Dç¿»è½¬) --- */
        .card {
            width: 160px;
            height: 260px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.27), box-shadow 0.3s;
            cursor: pointer;
            opacity: 0; /* åˆå§‹éšè—ï¼ŒæŒ¥æ‰‹åæ˜¾ç¤º */
            transform: translateY(100px); 
        }

        /* å¡ç‰Œå±•å¼€åŠ¨ç”» */
        .card.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* é€‰ä¸­æ€ */
        .card.hovered {
            transform: translateY(-20px) scale(1.05);
            box-shadow: 0 0 25px rgba(189, 147, 249, 0.6);
        }
        
        /* ç¿»è½¬æ€ */
        .card.flipped {
            transform: rotateY(180deg) scale(1.1);
        }

        /* å¡èƒŒä¸å¡é¢ */
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .card-back {
            background: linear-gradient(135deg, #2c2c2c, #111);
            border: 2px solid #444;
            color: rgba(255,255,255,0.2);
            font-size: 40px;
        }
        /* å¾…æ¿€æ´»çŠ¶æ€çš„äº®ç™½è‰²æ ·å¼ */
        .card-back::after {
            content: 'âœ¦';
            font-size: 50px;
            color: #fff;
            text-shadow: 0 0 20px #fff;
        }

        .card-front {
            background: linear-gradient(to bottom, #2b1055, #7597de);
            transform: rotateY(180deg);
            border: 2px solid #ffd700;
            color: white;
            padding: 10px;
            text-align: center;
        }

        .tarot-name {
            margin-top: 10px;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
        }

        .tarot-img-placeholder {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        /* --- æ‰‹åŠ¿å…‰æ ‡ --- */
        #cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #00ffff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* ç©¿é€ç‚¹å‡» */
            z-index: 500;
            box-shadow: 0 0 10px #00ffff;
            transition: width 0.1s, height 0.1s, background-color 0.1s;
        }

        /* æåˆæ—¶çš„å…‰æ ‡æ ·å¼ */
        #cursor.clicking {
            background-color: #00ffff;
            width: 15px;
            height: 15px;
        }

        /* --- ç²’å­ç”»å¸ƒ --- */
        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 400;
        }
    </style>
</head>
<body>

    <!-- éšè—çš„ Video å…ƒç´ ï¼Œç”¨äº MediaPipe è¯»å– -->
    <video class="input_video"></video>
    
    <!-- çŠ¶æ€æç¤º -->
    <div id="status-text">è¯·æŒ¥æ‰‹ä»¥æ¿€æ´»å¡ç‰Œ...</div>

    <!-- å…‰æ ‡ -->
    <div id="cursor"></div>

    <!-- ç²’å­ç‰¹æ•ˆå±‚ -->
    <canvas id="particle-canvas"></canvas>

    <!-- æ¸¸æˆåŒº -->
    <div id="card-container">
        <!-- å¡ç‰Œç”± JS ç”Ÿæˆ -->
    </div>

<script>
    // ================= é…ç½®ä¸å˜é‡ =================
    const videoElement = document.getElementsByClassName('input_video')[0];
    const cursor = document.getElementById('cursor');
    const statusText = document.getElementById('status-text');
    const cardContainer = document.getElementById('card-container');
    const particleCanvas = document.getElementById('particle-canvas');
    const ctxParticles = particleCanvas.getContext('2d');

    // å¡”ç½—ç‰Œæ•°æ®
    const tarotData = [
        { name: "åŠ›é‡", en: "Strength", icon: "ğŸ¦" },
        { name: "æ„šè€…", en: "The Fool", icon: "ğŸƒ" },
        { name: "æ­»ç¥", en: "Death", icon: "ğŸ’€" },
        { name: "å®å‰‘éª‘å£«", en: "Knight of Swords", icon: "âš”ï¸" },
        { name: "å¥³çš‡", en: "The Empress", icon: "ğŸ‘‘" }
    ];

    let gameState = 'IDLE'; // IDLE, ACTIVE, REVEALED
    let cursorX = window.innerWidth / 2;
    let cursorY = window.innerHeight / 2;
    // ç”¨äºå¹³æ»‘å…‰æ ‡
    let targetX = cursorX;
    let targetY = cursorY;

    // æŒ¥æ‰‹æ£€æµ‹å˜é‡
    let handHistory = [];
    const WAVE_THRESHOLD = 150; // ç§»åŠ¨è·ç¦»é˜ˆå€¼

    // ç‚¹å‡»/æåˆå†·å´
    let isPinching = false;
    let lastPinchTime = 0;

    // ç²’å­æ•°ç»„
    let particles = [];

    // ================= åˆå§‹åŒ– =================
    
    // è®¾ç½® Canvas å°ºå¯¸
    function resizeCanvas() {
        particleCanvas.width = window.innerWidth;
        particleCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ç”Ÿæˆå¡ç‰Œ DOM
    function initCards() {
        cardContainer.innerHTML = '';
        tarotData.forEach((data, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `card-${index}`;
            
            const back = document.createElement('div');
            back.className = 'card-face card-back';
            
            const front = document.createElement('div');
            front.className = 'card-face card-front';
            front.innerHTML = `
                <div class="tarot-img-placeholder">${data.icon}</div>
                <div class="tarot-name">${data.name}</div>
                <div style="font-size:12px; opacity:0.8">${data.en}</div>
            `;

            card.appendChild(back);
            card.appendChild(front);
            cardContainer.appendChild(card);
        });
    }
    initCards();

    // ================= é€»è¾‘åŠŸèƒ½ =================

    // 1. çº¿æ€§æ’å€¼ (Lerp) å®ç°å¹³æ»‘ç§»åŠ¨
    function lerp(start, end, amt) {
        return (1 - amt) * start + amt * end;
    }

    // 2. æŒ¥æ‰‹æ£€æµ‹ (ç®€å•çš„é€Ÿåº¦/ä½ç§»æ£€æµ‹)
    function detectWave(landmarks) {
        if (gameState !== 'IDLE') return;

        // ä½¿ç”¨æ‰‹è…• (ç´¢å¼• 0) çš„ X åæ ‡
        const x = landmarks[0].x;
        handHistory.push(x);
        if (handHistory.length > 20) handHistory.shift();

        if (handHistory.length > 10) {
            const minX = Math.min(...handHistory);
            const maxX = Math.max(...handHistory);
            // å¦‚æœçŸ­æ—¶é—´å†…æ¨ªå‘ç§»åŠ¨å¹…åº¦å¤§
            if (maxX - minX > 0.4) { 
                startGame();
                handHistory = []; // é‡ç½®
            }
        }
    }

    // 3. æ¸¸æˆæµç¨‹æ§åˆ¶
    function startGame() {
        gameState = 'ACTIVE';
        statusText.innerText = "è¯·é€šè¿‡æ‰‹åŠ¿ç§»åŠ¨å…‰æ ‡ï¼Œæåˆæ‰‹æŒ‡ç¿»ç‰Œ";
        statusText.style.top = "5%";
        statusText.style.fontSize = "18px";

        // å¡ç‰Œå…¥åœºåŠ¨ç”»
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('active');
            }, index * 100);
        });
    }

    // 4. å¤„ç†äº¤äº’ (æ‚¬åœä¸ç‚¹å‡»)
    function handleInteraction(x, y, isPinch) {
        if (gameState !== 'ACTIVE') return;

        // è·å–å…‰æ ‡ä¸‹æ–¹çš„å…ƒç´  (å…ˆéšè—å…‰æ ‡è‡ªå·±ï¼Œå¦åˆ™æ£€æµ‹åˆ°çš„æ˜¯å…‰æ ‡div)
        cursor.style.display = 'none'; 
        let elemBelow = document.elementFromPoint(x, y);
        cursor.style.display = 'block';

        // ç§»é™¤æ‰€æœ‰æ‚¬åœæ•ˆæœ
        document.querySelectorAll('.card').forEach(c => c.classList.remove('hovered'));

        // æŸ¥æ‰¾æ˜¯å¦åœ¨å¡ç‰Œä¸Š
        let card = elemBelow ? elemBelow.closest('.card') : null;

        if (card && !card.classList.contains('flipped')) {
            card.classList.add('hovered');

            // è§¦å‘ç‚¹å‡» (æåˆ)
            if (isPinch) {
                const now = Date.now();
                if (now - lastPinchTime > 1000) { // 1ç§’é˜²æŠ–
                    flipCard(card);
                    lastPinchTime = now;
                }
            }
        }
    }

    // 5. ç¿»å¡é€»è¾‘
    function flipCard(card) {
        card.classList.add('flipped');
        
        // ç²’å­ç‰¹æ•ˆä½ç½®
        const rect = card.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        createExplosion(centerX, centerY);

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨ç¿»å¼€ (å¯é€‰é€»è¾‘)
        // ...
    }

    // ================= MediaPipe è®¾ç½® =================

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    // æ‘„åƒå¤´åˆå§‹åŒ–
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 640,
        height: 480
    });
    camera.start();

    // ================= æ¯ä¸€å¸§çš„å¤„ç†é€»è¾‘ =================

    function onResults(results) {
        // 1. è·å–æ‰‹éƒ¨æ•°æ®
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];

            // 2. æ£€æµ‹æŒ¥æ‰‹ (ä»…åœ¨ Idle çŠ¶æ€)
            detectWave(landmarks);

            // 3. è®¡ç®—å…‰æ ‡ä½ç½® (ä½¿ç”¨é£ŸæŒ‡æŒ‡å°– ID: 8)
            // é•œåƒç¿»è½¬ X åæ ‡ (1 - x)
            const rawX = (1 - landmarks[8].x) * window.innerWidth;
            const rawY = landmarks[8].y * window.innerHeight;

            // å¹³æ»‘ç§»åŠ¨
            targetX = rawX;
            targetY = rawY;

            // 4. æ£€æµ‹æåˆ (é£ŸæŒ‡æŒ‡å°– ID: 8 ä¸ æ‹‡æŒ‡æŒ‡å°– ID: 4 çš„è·ç¦»)
            const x1 = landmarks[8].x;
            const y1 = landmarks[8].y;
            const x2 = landmarks[4].x;
            const y2 = landmarks[4].y;
            
            // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»
            const distance = Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
            
            // é˜ˆå€¼åˆ¤æ–­ (è§†æ‘„åƒå¤´è·ç¦»è€Œå®šï¼Œé€šå¸¸ 0.05 å·¦å³ä¸ºæåˆ)
            if (distance < 0.05) {
                cursor.classList.add('clicking');
                isPinching = true;
            } else {
                cursor.classList.remove('clicking');
                isPinching = false;
            }

        } else {
            // æ²¡æœ‰æ£€æµ‹åˆ°æ‰‹æ—¶
            isPinching = false;
        }
    }

    // åŠ¨ç”»å¾ªç¯ (æ¸²æŸ“ UI å’Œ ç²’å­)
    function animate() {
        // 1. æ›´æ–°å…‰æ ‡ DOM ä½ç½® (Lerp)
        // ä½¿ cursorX è¶‹å‘ targetX
        cursorX = lerp(cursorX, targetX, 0.2); 
        cursorY = lerp(cursorY, targetY, 0.2);

        cursor.style.left = `${cursorX}px`;
        cursor.style.top = `${cursorY}px`;

        // 2. äº¤äº’é€»è¾‘
        handleInteraction(cursorX, cursorY, isPinching);

        // 3. æ¸²æŸ“ç²’å­
        updateParticles();

        requestAnimationFrame(animate);
    }
    
    // å¯åŠ¨åŠ¨ç”»å¾ªç¯
    animate();


    // ================= ç²’å­ç³»ç»Ÿ (Canvas) =================
    
    class Particle {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0; // ç”Ÿå‘½å€¼ 1.0 -> 0
            this.decay = Math.random() * 0.02 + 0.01;
            this.color = `hsl(${Math.random() * 60 + 200}, 100%, 70%)`; // è“è‰²/ç´«è‰²ç³»
            this.size = Math.random() * 4 + 2;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= this.decay;
            this.size *= 0.95; // å˜å°
        }

        draw(ctx) {
            ctx.fillStyle = this.color;
            ctx.globalAlpha = this.life;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    function createExplosion(x, y) {
        for (let i = 0; i < 30; i++) {
            particles.push(new Particle(x, y));
        }
    }

    function updateParticles() {
        ctxParticles.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
        
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.update();
            p.draw(ctxParticles);
            
            if (p.life <= 0) {
                particles.splice(i, 1);
            }
        }
    }

</script>
</body>
</html>

