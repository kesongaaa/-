<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘½è¿å¡”ç½— - æ‰‹åŠ¿äº’åŠ¨ç‰ˆ</title>
    <!-- å¼•å…¥ MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        /* --- 1. åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #080808;
            --accent-gold: #d4af37;
            --accent-green: #00ff88; /* ç»¿è‰²å…‰åœˆé¢œè‰² */
            --card-width: 140px;
            --card-height: 240px;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(20, 20, 20, 1) 0%, rgba(0, 0, 0, 1) 100%);
            color: #fff;
            font-family: 'Times New Roman', serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        /* --- 2. ç•Œé¢å±‚çº§ --- */
        #loading-screen, #game-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s;
        }

        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        h1 { font-size: 2.5rem; color: var(--accent-gold); margin-bottom: 10px; }
        p { color: #aaa; margin-bottom: 30px; }

        /* --- 3. ç»¿è‰²é€‰æ‹©å…‰åœˆ (æ ¸å¿ƒäº¤äº’) --- */
        #selection-ring {
            position: fixed;
            width: 60px;
            height: 60px;
            border: 4px solid var(--accent-green);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--accent-green), inset 0 0 10px var(--accent-green);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 100;
            transition: left 0.1s ease-out, top 0.1s ease-out, width 0.2s, height 0.2s;
            display: none;
        }

        /* æ¡æ‹³æ—¶çš„çŠ¶æ€æç¤º */
        #fist-hint {
            position: fixed;
            bottom: 30px;
            font-size: 1.2rem;
            color: var(--accent-green);
            opacity: 0;
            transition: opacity 0.3s;
            text-shadow: 0 0 10px var(--accent-green);
            z-index: 200;
        }

        /* --- 4. å¡ç‰Œå®¹å™¨ --- */
        #card-container {
            display: flex;
            gap: 20px;
            perspective: 1000px;
            z-index: 10;
        }

        .card-wrapper {
            width: var(--card-width);
            height: var(--card-height);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .card-wrapper.flipped { transform: rotateY(180deg); }
        .card-wrapper.resetting { animation: shake 0.5s; }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* å¡èƒŒï¼šç¥ç§˜èŠ±çº¹ */
        .card-back {
            background: #1a1a1a;
            background-image: repeating-linear-gradient(45deg, #222 25%, transparent 25%, transparent 75%, #222 75%, #222), repeating-linear-gradient(45deg, #222 25%, #1a1a1a 25%, #1a1a1a 75%, #222 75%, #222);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            border-color: #444;
        }
        .card-back::after {
            content: 'â˜ª';
            font-size: 4rem;
            color: #555;
        }

        /* è¢«ç»¿è‰²å…‰åœˆé€‰ä¸­æ—¶çš„æ•ˆæœ */
        .card-wrapper.selected .card-back {
            border-color: var(--accent-green);
            box-shadow: 0 0 25px var(--accent-green);
        }

        /* å¡é¢ */
        .card-front {
            background: #eee;
            color: #000;
            transform: rotateY(180deg);
        }
        .card-front img { width: 100%; height: 75%; object-fit: cover; }
        .card-front div { height: 25%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; }

        /* --- 5. è¾…åŠ©å…ƒç´  --- */
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 50; }
        #webcam { position: fixed; top: 10px; right: 10px; width: 120px; opacity: 0.2; transform: scaleX(-1); border-radius: 8px; }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 768px) {
            :root { --card-width: 80px; --card-height: 140px; }
            #card-container { gap: 10px; flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- è§†è§‰å…ƒç´  -->
    <div id="selection-ring"></div>
    <div id="fist-hint">ğŸ‘Š æ£€æµ‹åˆ°æ¡æ‹³ï¼šæ­£åœ¨é‡ç½®ç‰Œé˜µ...</div>
    <canvas id="particle-canvas"></canvas>
    <video id="webcam" autoplay playsinline></video>

    <!-- åŠ è½½ä¸å¼•å¯¼ -->
    <div id="loading-screen">
        <h1>ğŸ”® æ­£åœ¨å¬å”¤å¡”ç½—ç‰Œé˜µ...</h1>
        <p>è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥è¿›è¡Œæ‰‹åŠ¿äº’åŠ¨</p>
        <button id="start-btn" style="padding: 10px 30px; background: var(--accent-gold); border: none; font-size: 1.2rem; cursor: pointer; display: none;">å¼€å§‹ä»ªå¼</button>
    </div>

    <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
    <div id="game-screen" class="hidden">
        <h2 style="position: absolute; top: 10%; color: var(--accent-green); text-shadow: 0 0 10px var(--accent-green);">è¯·ç”¨æ‰‹åŠ¿é€‰æ‹©æ‚¨çš„å‘½è¿</h2>
        <div id="card-container"></div>
    </div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

        /* --- 1. å¡”ç½—ç‰Œæ•°æ® (ç»å…¸ç‰Œé¢) --- */
        const cardsData = [
            { name: "åŠ›é‡ Strength", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/RWS_Tarot_08_Strength.jpg/344px-RWS_Tarot_08_Strength.jpg" },
            { name: "å®å‰‘ä¸‰ 3 of Swords", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Swords03.jpg/347px-Swords03.jpg" },
            { name: "æƒæ–äº” 5 of Wands", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Wands05.jpg/352px-Wands05.jpg" },
            { name: "æˆ˜è½¦ The Chariot", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/RWS_Tarot_07_Chariot.jpg/353px-RWS_Tarot_07_Chariot.jpg" },
            { name: "å‘½è¿ä¹‹è½® Wheel of Fortune", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg/352px-RWS_Tarot_10_Wheel_of_Fortune.jpg" }
        ];

        /* --- 2. å˜é‡ä¸çŠ¶æ€ --- */
        let handLandmarker;
        let webcamRunning = false;
        let lastVideoTime = -1;
        let lastSelectedIdx = -1;
        let hoverStartTime = 0;
        const HOVER_TRIGGER_TIME = 500; // 0.5ç§’è§¦å‘ç¿»ç‰Œ
        
        // DOM
        const video = document.getElementById("webcam");
        const ring = document.getElementById("selection-ring");
        const container = document.getElementById("card-container");
        const particleCanvas = document.getElementById("particle-canvas");
        const ctx = particleCanvas.getContext('2d');
        const fistHint = document.getElementById("fist-hint");

        /* --- 3. åˆå§‹åŒ– MediaPipe --- */
        async function setupVision() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
            document.getElementById('start-btn').style.display = 'block';
            document.querySelector('#loading-screen h1').innerText = "ğŸ”® å‡†å¤‡å°±ç»ª";
        }
        setupVision();

        /* --- 4. æ¸¸æˆæµç¨‹æ§åˆ¶ --- */
        function initGame() {
            container.innerHTML = '';
            cardsData.forEach((data, i) => {
                const card = document.createElement('div');
                card.className = 'card-wrapper';
                card.id = `card-${i}`;
                card.innerHTML = `
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front">
                        <img src="${data.img}" alt="${data.name}">
                        <div>${data.name}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        document.getElementById('start-btn').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                webcamRunning = true;
                
                initGame();
                resizeCanvas();
                
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                ring.style.display = 'block';
            } catch(e) { alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™"); }
        };

        /* --- 5. æ ¸å¿ƒé€»è¾‘ï¼šæ‰‹åŠ¿è¯†åˆ« Loop --- */
        async function predictWebcam() {
            if (!handLandmarker) return;
            
            // ä¿æŒCanvaså°ºå¯¸
            if (video.videoWidth && particleCanvas.width !== window.innerWidth) resizeCanvas();

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, performance.now());

                if (results.landmarks && results.landmarks.length > 0) {
                    const landmarks = results.landmarks[0];
                    const indexTip = landmarks[8]; // é£ŸæŒ‡å°–
                    
                    // 1. æ˜ å°„åæ ‡ (é•œåƒç¿»è½¬)
                    const x = (1 - indexTip.x) * window.innerWidth;
                    const y = indexTip.y * window.innerHeight;

                    // 2. ç§»åŠ¨ç»¿è‰²å…‰åœˆ
                    ring.style.left = `${x}px`;
                    ring.style.top = `${y}px`;

                    // 3. æ£€æµ‹æ¡æ‹³ (é‡ç½®æ¸¸æˆ)
                    if (detectFist(landmarks)) {
                        handleFistReset();
                    } else {
                        // 4. å¤„ç†é€‰å¡é€»è¾‘
                        handleSelection(x, y);
                        fistHint.style.opacity = 0;
                    }
                } else {
                    ring.style.display = 'none'; // æ²¡æ‰‹æ—¶éšè—å…‰åœˆ
                }
            }
            
            updateParticles();
            window.requestAnimationFrame(predictWebcam);
        }

        /* --- 6. äº¤äº’é€»è¾‘ç»†èŠ‚ --- */
        
        // æ¡æ‹³æ£€æµ‹ç®—æ³•ï¼šæŒ‡å°–(8,12,16,20)åˆ°æ‰‹è…•(0)çš„è·ç¦»ç¼©çŸ­
        function detectFist(landmarks) {
            const wrist = landmarks[0];
            const tips = [8, 12, 16, 20]; 
            let foldedFingers = 0;
            
            tips.forEach(tipIdx => {
                const tip = landmarks[tipIdx];
                const mcp = landmarks[tipIdx - 3]; // æŒ‡æ ¹
                // ç®€å•çš„åˆ¤æ–­ï¼šæŒ‡å°–å¦‚æœä¸æ¯”æŒ‡æ ¹é«˜(yå€¼å°)ï¼Œæˆ–è€…è·ç¦»æ‰‹è…•å¾ˆè¿‘
                const distToWrist = Math.sqrt(Math.pow(tip.x - wrist.x, 2) + Math.pow(tip.y - wrist.y, 2));
                if (distToWrist < 0.15) foldedFingers++; // é˜ˆå€¼éœ€æ ¹æ®å®é™…æƒ…å†µå¾®è°ƒ
            });
            return foldedFingers >= 3; // 3æ ¹ä»¥ä¸Šæ‰‹æŒ‡èœ·ç¼©ç®—æ¡æ‹³
        }

        let isResetting = false;
        function handleFistReset() {
            if (isResetting) return;
            fistHint.style.opacity = 1;
            
            // ç®€å•çš„é˜²æŠ–ï¼Œæ¡æ‹³ä¿æŒä¸€ä¸‹æ‰è§¦å‘
            if (!window.fistTimer) {
                window.fistTimer = setTimeout(() => {
                    isResetting = true;
                    // é‡ç½®åŠ¨ç”»
                    const cards = document.querySelectorAll('.card-wrapper');
                    cards.forEach(c => {
                        c.classList.remove('flipped');
                        c.classList.add('resetting');
                    });
                    setTimeout(() => {
                        cards.forEach(c => c.classList.remove('resetting'));
                        isResetting = false;
                        window.fistTimer = null;
                    }, 1000);
                }, 800); // æ¡æ‹³0.8ç§’è§¦å‘
            }
        }

        function handleSelection(x, y) {
            if (window.fistTimer) { clearTimeout(window.fistTimer); window.fistTimer = null; }
            if (isResetting) return;

            const cards = document.querySelectorAll('.card-wrapper');
            let currentHoverIdx = -1;

            cards.forEach((card, idx) => {
                const rect = card.getBoundingClientRect();
                // ç¢°æ’æ£€æµ‹
                if (x > rect.left && x < rect.right && y > rect.top && y < rect.bottom) {
                    currentHoverIdx = idx;
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // ç¿»ç‰Œè§¦å‘é€»è¾‘
            if (currentHoverIdx !== -1) {
                if (currentHoverIdx !== lastSelectedIdx) {
                    // åˆšç§»å…¥æ–°å¡ç‰Œï¼Œé‡ç½®è®¡æ—¶å™¨
                    lastSelectedIdx = currentHoverIdx;
                    hoverStartTime = performance.now();
                    ring.style.borderColor = 'var(--accent-green)'; // æ­£å¸¸ç»¿è‰²
                } else {
                    // æŒç»­åœç•™åœ¨åŒä¸€å¼ å¡
                    const dwellTime = performance.now() - hoverStartTime;
                    
                    // è§†è§‰åé¦ˆï¼šå…‰åœˆå˜è‰²è¡¨ç¤ºå³å°†è§¦å‘
                    if (dwellTime > 200) ring.style.borderColor = '#fff'; 

                    if (dwellTime > HOVER_TRIGGER_TIME) {
                        const targetCard = cards[currentHoverIdx];
                        if (!targetCard.classList.contains('flipped')) {
                            flipCard(targetCard);
                        }
                    }
                }
            } else {
                lastSelectedIdx = -1;
                ring.style.borderColor = 'var(--accent-green)';
            }
        }

        function flipCard(card) {
            card.classList.add('flipped');
            // è§¦å‘ç²’å­
            const rect = card.getBoundingClientRect();
            spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2);
        }

        /* --- 7. æ˜Ÿå…‰ç²’å­ç³»ç»Ÿ --- */
        let particles = [];
        function resizeCanvas() { particleCanvas.width = window.innerWidth; particleCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);

        function spawnParticles(x, y) {
            for(let i=0; i<40; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 1,
                    color: `hsl(${40 + Math.random()*20}, 100%, 70%)` // é‡‘è‰²
                });
            }
        }

        function updateParticles() {
            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, Math.random()*3 + 1, 0, Math.PI*2);
                ctx.fill();
                if(p.life <= 0) particles.splice(i, 1);
            });
        }

    </script>
</body>
</html>
